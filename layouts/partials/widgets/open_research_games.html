{{/*
  Open Research Games Portal Widget
  
  Purpose: Main widget for displaying game cards with filtering and search functionality
  Data Source: site.Data.open_research_games (from data/open_research_games.json)
  
  
  Card Information Displayed:
  - Game title
  - Description (truncated)
  - Gameplay style
  - FORRT clusters (for filtering)
  - Play Now and Details buttons
  
  Filtering System:
  - Uses CSS classes: js-id-all, js-id-cluster-1, js-id-cluster-2, etc.
  - Isotope.js handles dynamic filtering
  - Filter buttons defined in content/open-research-games-portal/games.md
*/}}

{{/* Initialise */}}
{{ $ := .root }}
{{ $st := .page }}
{{ $columns := $st.Params.design.columns | default "2" }}

{{ if ne $columns "1" }}
{{/* Standard dual-column layout. */}}

<div class="row">
  <div class="col-12 col-lg-4 section-heading">

    {{ with $st.Title }}<h1>{{ . | markdownify | emojify }}</h1>{{ end }}
    {{ with $st.Params.subtitle }}<p>{{ . | markdownify | emojify }}</p>{{ end }}

  </div>
  <div class="col-12 col-lg-8">

    {{ else }}
    {{/* Single column layout. */}}

    <div class="margin-auto">

      <div class="center-text">
        {{ with $st.Title }}<h1 class="mt-0">{{ . | markdownify | emojify }}</h1>{{ end }}
        {{ with $st.Params.subtitle }}<p>{{ . | markdownify | emojify }}</p>{{ end }}
      </div>
      <div>
        {{ end }}

        {{ with $st.Content }}{{ . }}{{ end }}

        {{ if $st.Params.content.filter_button }}

        {{ $filter_default := default (int $st.Params.content.filter_default) 0 }}

        {{/* Parse default filter tag from front matter in the form of either tag name or CSS class name. */}}
        {{ $default_filter_tag_raw := (index $st.Params.content.filter_button ($filter_default)).forrt_clusters }}
        {{ $default_filter_tag := printf ".js-id-%s" (replace $default_filter_tag_raw " " "-") }}
        {{ if or (eq (substr $default_filter_tag_raw 0 1) "*") (eq (substr $default_filter_tag_raw 0 1) ".") }}
        {{ $default_filter_tag = $default_filter_tag_raw }}
        {{ end }}

        <span class="d-none default-project-filter">{{ $default_filter_tag }}</span>

        {{/* Only show filter buttons if there are multiple filters. */}}
        {{ if gt (len $st.Params.content.filter_button) 1 }}
        <div class="project-toolbar">
          <div class="project-filters">
            <div class="btn-toolbar">
              <div class="btn-group flex-wrap text-center">
                {{ range $idx, $item := $st.Params.content.filter_button }}
                {{/* Parse filter tag from front matter in the form of either tag name or CSS class name. */}}
                {{ $data_filter := printf ".js-id-%s" (replace .forrt_clusters " " "-") }}
                {{ if or (eq (substr .forrt_clusters 0 1) "*") (eq (substr .forrt_clusters 0 1) ".") }}
                {{ $data_filter = .forrt_clusters }}
                {{ end }}
                <a href="#" data-filter="{{ $data_filter | safeHTMLAttr }}"
                  class="btn btn-primary py-2 m-1 btn-lg{{ if eq $idx $filter_default }} active{{ end }}" style="line-height: 1; border-radius: 6px;">{{ .name }}</a>
                {{ end }}
              </div>
            </div>
          </div>
        </div>
        {{ end }}
        {{ end }}

        <div class="isotope projects-container js-layout-masonry" id="games-container">
          {{ range $slug, $item := site.Data.open_research_games }}

          {{/* Create filter classes from FORRT clusters */}}
          {{ $js_tag_classes := "js-id-all" }}
          {{ if $item.forrt_clusters }}
            {{ $clusters := $item.forrt_clusters }}
            {{ if reflect.IsSlice $clusters }}
              {{ $cluster_classes := slice }}
              {{ range $clusters }}
                {{ if strings.Contains . "Cluster 1" }}{{ $cluster_classes = $cluster_classes | append "js-id-cluster-1" }}{{ end }}
                {{ if strings.Contains . "Cluster 2" }}{{ $cluster_classes = $cluster_classes | append "js-id-cluster-2" }}{{ end }}
                {{ if strings.Contains . "Cluster 3" }}{{ $cluster_classes = $cluster_classes | append "js-id-cluster-3" }}{{ end }}
                {{ if strings.Contains . "Cluster 4" }}{{ $cluster_classes = $cluster_classes | append "js-id-cluster-4" }}{{ end }}
                {{ if strings.Contains . "Cluster 5" }}{{ $cluster_classes = $cluster_classes | append "js-id-cluster-5" }}{{ end }}
                {{ if strings.Contains . "Cluster 6" }}{{ $cluster_classes = $cluster_classes | append "js-id-cluster-6" }}{{ end }}
                {{ if strings.Contains . "Cluster 7" }}{{ $cluster_classes = $cluster_classes | append "js-id-cluster-7" }}{{ end }}
                {{ if strings.Contains . "Cluster 8" }}{{ $cluster_classes = $cluster_classes | append "js-id-cluster-8" }}{{ end }}
              {{ end }}
              {{ $js_tag_classes = delimit $cluster_classes " " }}
            {{ end }}
          {{ end }}

          <div class="project-card project-item isotope-item py-1 {{ $js_tag_classes | safeHTMLAttr }}">
            <div class="card game-card">
              <div class="card-body">
                <h5 class="card-title border-bottom border-warning pb-2">
                  {{ $item.title }}
                </h5>
                
                {{ with $item.description }}
                <p class="card-text">{{ . | truncate 200 }}</p>
                {{ end }}
                
                <div class="game-metadata">
                  {{ with $item.gameplay_style }}
                  <p class="small mb-1"><strong>Gameplay:</strong> {{ . }}</p>
                  {{ end }}
                  
                  {{ with $item.language }}
                  <p class="small mb-1">
                    <strong>Language:</strong> 
                    {{ if reflect.IsSlice . }}{{ delimit . ", " }}{{ else }}{{ . }}{{ end }}
                  </p>
                  {{ end }}
                  
                  {{ with $item.playtime }}
                  <p class="small mb-1"><strong>Playtime:</strong> {{ . }}</p>
                  {{ end }}
                  
                  {{ with $item.topic_area }}
                  <p class="small mb-1">
                    <strong>Topics:</strong> 
                    {{ if reflect.IsSlice . }}{{ delimit . ", " }}{{ else }}{{ . }}{{ end }}
                  </p>
                  {{ end }}
                </div>
                
                <div class="mt-3 d-flex justify-content-between align-items-center">
                  {{ if $item.access }}
                  <a href="{{ $item.access }}" target="_blank" rel="noopener" class="btn btn-success btn-sm btn-play-now">
                    <i class="fas fa-play mr-1"></i>Play Now
                  </a>
                  {{ end }}
                  
                  <button class="btn btn-outline-info btn-sm" onclick="showGameDetails('{{ $slug }}')">
                    <i class="fas fa-info-circle mr-1"></i>Details
                  </a>
                </div>
              </div>
            </div>
          </div>


          {{ end }}
        </div>

        <div class="mt-4">
          <p class="text-center text-muted">
            <strong>{{ len site.Data.open_research_games }}</strong> games available in the portal
          </p>
        </div>

      </div>
    </div>


