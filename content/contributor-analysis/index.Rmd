---
title: "FORRT Contributor Analyses"
always_allow_html: true
output:
  md_document:
    variant: gfm
    preserve_yaml: true
    toc: false
type: contributors_analysis
---



```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, fig.path = ""
)
```

```{r Load Libraries}
library(dplyr)   # For data manipulation
library(ggplot2) # For visualization
library(tidyr)   # For reshaping data
library(googlesheets4) # For reading Google Sheets
library(stringr) # For removing unwanted characters around strings
library(here)
library(readr)
library(sysfonts)
library(showtext)
library(treemapify)

font_add_google("Domine", "Domine")
showtext_auto()
```

```{r Read contributor data from cache}

# Read role column mappings (same source as tenzing.py)
fields_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_IaXiYtB3iAmtDZ_XiQKrToRkxOlkXNAeNU2SIT_J9PxvsQyptga6Gg9c8mSvDZpwY6d8skswIQYh/pub?output=csv&gid=277271370"
role_cols <- read_csv(fields_url, show_col_types = FALSE) |> pull(Fields)

# Read contributor data from cache (generated by tenzing.py)
cache_path <- here("scripts", "forrt_contribs", "contributors_cache.csv")
credit_roles <- read_csv(cache_path, show_col_types = FALSE)

```

```{r Read sheets from leads tenzing}

# Define Google Sheet URL for Leads Tenzing
google_sheet_url_leads <- "https://docs.google.com/spreadsheets/d/1roy-sZTxyXENA5c5IIV7IIemYvzbzs7zojUN2yIpi58/edit?gid=0#gid=0"

gs4_deauth()

lead_roles <- read_sheet(google_sheet_url_leads) |>
  rename(
    `Project Name` = `FORRT project(s)`,
    `ORCID iD` = `ORCID`
  ) |>
  select(`First name`, `Middle name`, `Surname`, `Project Name`, `Role`, `ORCID iD`) |>
  mutate(has_role = TRUE) |>
  distinct(`First name`, `Middle name`, `Surname`, `Project Name`, `ORCID iD`, `Role`, .keep_all = TRUE) |>
  pivot_wider(names_from = `Role`, values_from = `has_role`, values_fill = list(has_role = FALSE)) |>
  # Remove FORRT-wide organizational roles (not project-level contributions)
  select(-Director, -`Operations Coordinator`)

```

```{r Combine roles from leads tenzing with automation source}

# Get leadership role columns (everything except ID columns)
id_cols <- c("First name", "Middle name", "Surname", "Project Name", "ORCID iD")
leads_role_cols <- setdiff(names(lead_roles), id_cols)
all_role_cols <- union(role_cols, leads_role_cols)

# Combine leads tenzing rows with automation source
contributions <- bind_rows(credit_roles, lead_roles)
```

```{r Trim Values For Consistency}

# Trim names and ORCIDs to ensure inconsistent Tenzing entries are not counted separately 
contributions <- contributions |>
  mutate(
    `First name` = str_trim(str_replace_all(`First name`, "\\*", "")),  # Remove * and trim spaces
    `Middle name` = str_trim(str_replace_all(`Middle name`, "\\*", "")) |> str_sub(1, 1),  # Remove *, trim spaces, and keep first letter
    `Surname` = str_trim(str_replace_all(`Surname`, "\\*", "")),  # Remove * and trim spaces
    `ORCID iD` = str_trim(str_remove(`ORCID iD`, "https://orcid.org/"))  # Remove ORCID URL prefix and trim spaces
  )
```

```{r Metrics}
# Count unique contributors (only use surname and first name at the moment, middle name causes problems)
unique_contributors <- contributions |>
  distinct(Surname, `First name`) |>
  nrow()

# Contributions per person
contributions_per_person <- contributions |>
  summarise(Contributions = n(), .by = c(Surname, `First name`))

# Mean contributions per person
mean_contributions_per_person <- mean(contributions_per_person$Contributions)
```

```{r Project Engagement}
count_projects <- n_distinct(contributions$`Project Name`)

# Contributors per project
project_contributors <- contributions |>
  distinct(`Project Name`, Surname, `First name`, `Middle name`) |>
  summarise(unique_contributors = n(), .by = `Project Name`) |>
  arrange(desc(unique_contributors)) 

# Reorder the 'Project Name' based on the number of unique contributors (descending)
project_contributors$`Project Name` <- factor(project_contributors$`Project Name`, 
                                              levels = project_contributors$`Project Name`)

# Roles and contributions distribution
contributions_long <- contributions |>
  pivot_longer(
    cols = any_of(all_role_cols),
    names_to = "Role", 
    values_to = "Contribution"
  ) |>
  filter(Contribution == TRUE)

role_distribution <- contributions_long |>
  count(Role, sort = TRUE)

mean_project_contributors <- mean(project_contributors$unique_contributors)
```

As of `r format(Sys.Date(), '%d %B %Y')`, FORRT has a total of `r count_projects` completed or ongoing projects and support teams, with a total of `r format(unique_contributors, big.mark = ',')` contributors. There is an average (mean) of `r round(mean_contributions_per_person, 2)` contributions per person across all FORRT projects, and the average number of contributors per project is `r round(mean_project_contributors)`. You can see the full list of FORRT contributors and their individual contributions [here](https://forrt.org/contributors/).


```{r Basic visualizations}
# Contributors per project

# Keep only the top 10 projects based on unique_contributors
project_contributors <- project_contributors |>
  arrange(desc(unique_contributors)) |>
  slice_head(n = 10)

# Plot
projects_plot <- ggplot(project_contributors, aes(y = reorder(`Project Name`, unique_contributors), x = unique_contributors)) +
  geom_segment(aes(x = 0, xend = unique_contributors, yend = reorder(`Project Name`, unique_contributors)),
               color = "#A52828", linewidth = 1) +
  geom_point(color = "#A52828", size = 4) +
  geom_text(aes(label = unique_contributors), hjust = -0.8, size = 5, family = "Domine", color = "#333333") +
  scale_x_continuous(limits = c(0, max(project_contributors$unique_contributors) * 1.15), expand = c(0, 0)) +
  labs(title = "Number of Contributors for FORRT's 10 Biggest Projects") +
  theme_minimal(base_size = 14, base_family = "Domine") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20, margin = margin(b = 20)),
        plot.title.position = "plot",
        axis.text.y = element_text(size = 14, color = "#333333"),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#fefdf6", color = NA),
        plot.background = element_rect(fill = "#fefdf6", color = NA),
        panel.border = element_blank(),
        panel.spacing = unit(0, "lines"),
        plot.margin = margin(t = 10, r = 10, b = 60, l = 10))

# Roles in projects

roles_plot <- ggplot(role_distribution, aes(y = reorder(Role, n), x = n)) +
  geom_col(fill = "#A52828", alpha = 0.8) +
  geom_text(aes(label = n), hjust = -0.3, size = 5, family = "Domine", color = "#333333") +
  scale_x_continuous(limits = c(0, max(role_distribution$n) * 1.1), expand = c(0, 0)) +
  labs(title = "Number of Contributions Across Roles",
       y = "Number of People") +
  theme_minimal(base_size = 14, base_family = "Domine") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20, margin = margin(b = 20)),
        plot.title.position = "plot",
        axis.text.y = element_text(size = 16, color = "#333333"),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#fefdf6", color = NA),
        plot.background = element_rect(fill = "#fefdf6", color = NA),
        panel.border = element_blank(),
        panel.spacing = unit(0, "lines"),
        plot.margin = margin(t = 10, r = 10, b = 10, l = 10))

# Treemap: number of projects per contributor
projects_per_person <- contributions_per_person |>
  mutate(
    label = case_when(
      Contributions == 1 ~ "1 project",
      Contributions >= 5 ~ "5 or more projects",
      TRUE ~ str_c(Contributions, " projects")
    )
  ) |>
  count(label) |>
  mutate(
    sort_order = case_when(
      str_detect(label, "^1") ~ 1L,
      str_detect(label, "^2") ~ 2L,
      str_detect(label, "^3") ~ 3L,
      str_detect(label, "^4") ~ 4L,
      TRUE ~ 5L
    ),
    percent = round(n / sum(n) * 100, 1)
  ) |>
  arrange(sort_order)

treemap_plot <- ggplot(projects_per_person, aes(area = n, fill = sort_order)) +
  geom_treemap() +
  geom_treemap_text(aes(label = label), colour = "white", place = "centre", size = 16, family = "Domine") +
  geom_treemap_text(aes(label = str_c("\n\n\n(", percent, "% of contributors)")), colour = "white", place = "centre", size = 11, family = "Domine") +
  scale_fill_gradient(low = "#e08a8a", high = "#A52828", guide = "none") +
  labs(title = "Share of Contributors by Number of Projects they Contributed To") +
  theme_minimal(base_size = 14, base_family = "Domine") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20, margin = margin(b = 20)),
        plot.title.position = "plot",
        panel.background = element_rect(fill = "#fefdf6", color = NA),
        plot.background = element_rect(fill = "#fefdf6", color = NA),
        plot.margin = margin(t = 10, r = 10, b = 60, l = 10))
```


```{r projects-plot, fig.alt = "Bar chart of contributors per project", fig.width = 10, fig.height = 7}
projects_plot
```

```{r treemap-plot, fig.alt = "Treemap of number of projects per contributor", fig.width = 10, fig.height = 7}
treemap_plot
```

```{r roles-plot, fig.alt = "Bar chart of contributions by Tenzing role", fig.width = 10, fig.height = 7}
roles_plot
```

```{r credit-roles-long}
contributions_long <- contributions_long |>
  unite(Contributor, Surname, `First name`, sep = " ", remove = FALSE, na.rm = TRUE) |>
  mutate(Lead = if_else(Role %in% c("lead", "co-lead"), Role, "other"))
```
