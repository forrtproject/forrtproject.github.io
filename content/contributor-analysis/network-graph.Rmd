---
title: "Network of Contributors"
output:
  html_document:
    self_contained: TRUE
    keep_md: FALSE
---

The interactive network visualization below shows the connections between FORRT contributors based on their collaborative work across different projects.

**How to read the graph:**

- **Nodes** represent contributor names. Each node is connected to other people involved in the same project(s).
- **Edges** (lines) represent connections between contributors who worked on the same project.

Use the dropdown menus below to search for a specific contributor by name or to filter the network by project. Hovering over a node highlights its connections and shows which projects that person contributed to. Clicking on a node highlights it in red, and clicking on an edge highlights the connection between two contributors. You can also zoom in and out using the scroll wheel or the navigation buttons.

<div style="margin-bottom: 40px;"></div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Domine:wght@400;700&display=swap');

body {
  background-color: #fefdf6;
  font-family: 'Domine', serif;
  font-size: 21px;
}

.network-container {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100vh;
  margin: 0 auto;
}

.vis-network {
  margin: 0 auto;
  display: block;
}

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE, 
  fig.path = ""
)
```

```{r load-libraries}
library(visNetwork)
library(dplyr)
library(tidyr)
library(igraph)
library(googlesheets4)
library(stringr)
library(here)
library(readr)
```

```{r data-processing}

# Read role column mappings (same source as tenzing.py)
fields_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_IaXiYtB3iAmtDZ_XiQKrToRkxOlkXNAeNU2SIT_J9PxvsQyptga6Gg9c8mSvDZpwY6d8skswIQYh/pub?output=csv&gid=277271370"
role_cols <- read_csv(fields_url, show_col_types = FALSE) |> pull(Fields)

# Read contributor data from cache (generated by tenzing.py)
cache_path <- here("scripts", "forrt_contribs", "contributors_cache.csv")
credit_roles <- read_csv(cache_path, show_col_types = FALSE)

```

```{r leads-data}
# Read Leads Tenzing data
google_sheet_url_leads <- "https://docs.google.com/spreadsheets/d/1roy-sZTxyXENA5c5IIV7IIemYvzbzs7zojUN2yIpi58/edit?gid=0#gid=0"
gs4_deauth()

lead_roles <- read_sheet(google_sheet_url_leads) |>
  rename(
    `Project Name` = `FORRT project(s)`,
    `ORCID iD` = `ORCID`
  ) |>
  select(`First name`, `Middle name`, `Surname`, `Project Name`, `Role`, `ORCID iD`) |>
  mutate(has_role = TRUE) |>
  distinct(`First name`, `Middle name`, `Surname`, `Project Name`, `ORCID iD`, `Role`, .keep_all = TRUE) |>
  pivot_wider(names_from = `Role`, values_from = `has_role`, values_fill = list(has_role = FALSE)) |>
  # Remove FORRT-wide organizational roles (not project-level contributions)
  select(-Director, -`Operations Coordinator`)

# Get leadership role columns (everything except ID columns)
id_cols <- c("First name", "Middle name", "Surname", "Project Name", "ORCID iD")
leads_role_cols <- setdiff(names(lead_roles), id_cols)

# TODO: Including leadership roles (all_role_cols) in the network pivot changes the
# graph topology significantly, which breaks the visIgraphLayout centering and makes
# the network unreadable. For now, only CRediT roles (role_cols) are used for the
# network. A future fix should integrate leadership roles without breaking the layout.
# all_role_cols <- union(role_cols, leads_role_cols)

# Combine leads tenzing rows with automation source (CRediT roles only)
credit_roles <- bind_rows(credit_roles, lead_roles)
```

```{r data-cleaning}
# Trim names and ORCIDs to ensure inconsistent Tenzing entries are not counted separately
credit_roles <- credit_roles |>
  mutate(
    `First name` = str_trim(str_replace_all(`First name`, "\\*", "")),
    `Middle name` = str_trim(str_replace_all(`Middle name`, "\\*", "")) |> str_sub(1, 1),
    Surname = str_trim(str_replace_all(Surname, "\\*", "")),
    `ORCID iD` = str_trim(str_remove(`ORCID iD`, "https://orcid.org/"))
  )
```

```{r network-data-preparation}
# Process data for network
credit_roles_long <- credit_roles |>
  pivot_longer(
    cols = any_of(role_cols),
    names_to = "Role",
    values_to = "has_role"
  ) |>
  filter(has_role == TRUE) |>
  unite(Contributor, Surname, `First name`, sep = " ", remove = FALSE, na.rm = TRUE) |>
  mutate(Lead = if_else(Role %in% c("lead", "co-lead"), Role, "other"))

# Get co-occurrences
contributor_project_matrix <- credit_roles_long |>
  distinct(`Project Name`, Contributor) |>
  xtabs(~ `Project Name` + Contributor, data = _, sparse = TRUE)

cooccurrence_matrix <- crossprod(contributor_project_matrix, contributor_project_matrix)
```

```{r create-nodes}
# Create nodes
node_counts <- credit_roles_long |>
  count(Contributor) |>
  rename(id = Contributor, value = n)

node_projects <- credit_roles_long |>
  distinct(Contributor, `Project Name`) |>
  summarise(projects = str_c(`Project Name`, collapse = ","), .by = Contributor) |>
  rename(id = Contributor)

contributor_nodes <- left_join(node_counts, node_projects, join_by(id)) |>
  mutate(title = str_c("<b>", id, "</b><br>", str_replace_all(projects, ",", "<br>")))
```

```{r create-edges}
# Create edges
contributor_edges <- which(upper.tri(cooccurrence_matrix), arr.ind = TRUE) |>
  as.data.frame() |>
  mutate(
    from = rownames(cooccurrence_matrix)[row],
    to   = colnames(cooccurrence_matrix)[col],
    width_n = cooccurrence_matrix[cbind(row, col)]
  ) |>
  filter(width_n > 0) |>
  mutate(width = (width_n / 10)^3) |>
  select(from, to, width)

# Add one hidden edge that will move the Chinese translator team closer to the center
additional_hidden_edge <- data.frame(
  from = c("Fang Cathy", "Chen Liangjie", "Jin Shuxian", "Yang Jinbiao",
           "Liu Ruoting", "Wang Xinyu", "Xu Yu", "Ji Xuejun", "Wang Zixi"),
  to = "Azevedo Flavio",
  width = 0.0,
  hidden = TRUE
)

plot_edges <- bind_rows(
  contributor_edges |> mutate(hidden = FALSE),
  additional_hidden_edge
)
```

```{r network-visualization, echo=FALSE}
# Create the network visualization
visNetwork(contributor_nodes, plot_edges, width = "100%", height = "800px") |>
  visLayout(randomSeed = 1001) |>
  visIgraphLayout(layout = "layout_with_fr", randomSeed = 1001, start.temp = 16) |>
  visPhysics(
    enabled = TRUE,
    stabilization = list(
      enabled = TRUE,
      iterations = 2000,
      fit = FALSE
    ),
    solver = "forceAtlas2Based",
    forceAtlas2Based = list(
      gravitationalConstant = -80,
      centralGravity = 0.4,
      springLength = 150,
      springConstant = 0.003,
      damping = 0.4,
      avoidOverlap = 0.2
    )
  ) |>
  visEdges(color = list(color = "#87CEEB", opacity = 0.3, hover = "#A52828", highlight = "#A52828")) |>
  visNodes(
    font = list(size = 4, strokeWidth = 1, strokeColor = "white"),
    size = 7,
    borderWidth = 0,
    color = list(background = "#000000", highlight = list(background = "#A52828", border = "darkred")),
    scaling = list(min = 3, max = 15)
  ) |>
  visInteraction(
    dragNodes = TRUE,
    dragView = TRUE,
    hover = TRUE,
    hoverConnectedEdges = TRUE,
    selectable = TRUE,
    selectConnectedEdges = TRUE,
    multiselect = TRUE,
    navigationButtons = TRUE
  ) |>
  visOptions(
    highlightNearest = list(enabled = TRUE, degree = 1, hover = TRUE, algorithm = "hierarchical"),
    nodesIdSelection = list(enabled = TRUE, main = "Select by contributor", style = "width: 240px; background: #f8f8f8;"),
    selectedBy = list(variable = "projects", multiple = TRUE, style = "width: 240px; background: #f8f8f8; margin-bottom: 30px;")
  ) |>
  htmlwidgets::onRender("
    function(el, x) {
      var network = this;

      // Set initial zoom level immediately
      network.on('initRedraw', function() {
        network.moveTo({
          scale: 0.042,
          animation: false
        });
      });

      // Maintain zoom after stabilization
      network.on('stabilized', function() {
        network.moveTo({
          scale: 0.012,
          animation: false
        });
      });

      network.on('click', function(params) {
        if (params.nodes.length === 0) {
          network.body.data.nodes.update(
            network.body.data.nodes.getIds().map(function(id) {
              return {id: id, color: {background: '#353839'}};
            })
          );
        }
      });
      
      network.on('selectNode', function(params) {
        network.body.data.nodes.update(
          network.body.data.nodes.getIds().map(function(id) {
            return {id: id, color: {background: '#353839'}};
          })
        );
        network.body.data.nodes.update({
          id: params.nodes[0],
          color: {background: '#A52828'}
        });
      });
    }
  ")
```

<!-- After knitting, move the output to the static folder before serving the site:
     mv content/contributor-analysis/network-graph.html static/partials/
     This step is handled automatically by the CI workflow (data-processing.yml). -->
